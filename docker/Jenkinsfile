pipeline {
    agent any
    environment {
        NAME = "tagdns_test"
        REPOSITORY = "https://github.com/tuimac/tagdns.git"
        DEPLOY = "/root/deploy"
        DOCKERFILE = "/root/deploy/tagdns/docker"
        TESTDIR="/opt/tagdns"
    }
    stages("Tagdns Pipeline") {
        stage("Clone tagdns project") {
            steps {
                dir("${DEPLOY}") {
                    sh "rm -rf tagdns"
                    sh "git clone ${REPOSITORY}"
                }
            }
        }
        stage("Build Image") {
            steps {
                dir("${DOCKERFILE}") {
                    sh "docker build -t ${NAME} ."
                }
            }
            post {
                failure {
                    sh "docker image prune -f"
                    echo "Failed to build image!"
                }
            }
        }
        stage("Start Container") {
            steps {
                sh "docker run -itd --name ${NAME} \
                                    -h ${NAME} \
                                    -v /etc/localtime:/etc/localtime:ro \
                                    -v volume:/tmp \
                                    -p 5353:53 \
                                    --network=bridge \
                                    ${NAME}"
            }
            post {
                failure {
                    sh "docker stop ${NAME}"
                    sh "docker rm ${NAME}"
                    sh "docker rmi ${NAME}"
                    sh "docker container prune -f"
                    sh "docker image prune -f"
                    echo "Failed to start container!"
                }
            }
        }
        stage("Connection Test") {
            steps {
                dir("${TESTDIR}/connection") {
                    sh "python3 test_connection.py -v"
                }
            }
            post {
                failure {
                    echo "There is no connection."
                }
            }
        }
        stage("DNS Query Test") {
            steps {
                dir("${TESTDIR}/dnsquery") {
                    sh "python3 test_dnsQuery.py -v"
                }
            }
            post {
                failure {
                    echo "Query name resolving was failed."
                }
            }
        }
    }
    post {
        cleanup {
            sh "docker stop ${NAME}"
            sh "docker rm ${NAME}"
            sh "docker rmi ${NAME}"
            sh "docker container prune -f"
            sh "docker image prune -f"
        }
        success {
            echo "No problem!!"
        }
        failure {
            echo "Failed to delete!"
        }
    }
}
