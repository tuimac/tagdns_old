pipeline {
    agent any
    environment {
        NAME = "tagdns_test"
        REPOSITORY = "https://github.com/tuimac/tagdns.git"
        DEPLOY = "/root/workspace"
        DOCKERFILE = "/root/workspace/tagdns/docker"
        UNITTESTDIR = "/root/tagdns/test/unit"
        INTTESTDIR = "/root/workspace/tagdns/test/integration"
        REPORT = "/root/tagdns/test/reports"
        IPADDR = "10.255.0.2"
    }
    stages("Tagdns Pipeline") {
        stage("Clone tagdns project") {
            steps {
                dir("${DEPLOY}") {
                    sh "rm -rf tagdns"
                    sh "git clone ${REPOSITORY}"
                    sh "cp -r ${HOME}/.aws ${DOCKERFILE}"
                }
            }
        }
        stage("Build Image") {
            steps {
                dir("${DOCKERFILE}") {
                    sh "docker build -t ${NAME} ."
                }
            }
            post {
                failure {
                    sh "python3 /root/tools/deletedockerenv.py ${NAME}"
                    echo "Failed to build image!"
                }
            }
        }
        stage("Create Docker Bridge Network") {
            steps {
                sh "docker network create \
                        --driver=bridge \
                        --subnet=10.255.0.0/28 \
                        --gateway=10.255.0.1 \
                        ${NAME}"
            }
            post {
                failure {
                    sh "python3 /root/tools/deletedockerenv.py ${NAME}"
                    echo "Failed to create bridge network!"
                }
            }
        }
        stage("Container Unit Test") {
            agent {
                docker {
                    image "${NAME}"
                    args "-itd --name ${NAME} \
                                -h ${NAME} \
                                -v /etc/localtime:/etc/localtime:ro \
                                --ip ${IPADDR} \
                                --network ${NAME}"
                }
            }
            steps {
                catchError(buildResult: "SUCCESS", stageResult: "FAILURE") {
                    sh "pip3 install git+${REPOSITORY}"
                    sh "cat /etc/tagdns/tagdns.yml"
                    sh "tagdns &"
                    sh "ls /var/log/tagdns"
                    sh "python3 ${UNITTESTDIR}/test_endpoint.py"
                }
            }
            post {
                always {
                    sh "docker cp ${NAME}:${REPORT} ."
                    junit "reports/*.xml"
                }
            }
        }
        stage("Start Container") {
            steps {
                sh "docker run -itd \
                                --name ${NAME} \
                                -h ${NAME} \
                                -v /etc/localtime:/etc/localtime:ro \
                                -v volume:/tmp \
                                --ip ${IPADDR} \
                                --network ${NAME} \
                                ${NAME}"
            }
            post {
                failure {
                    sh "python3 /root/tools/deletedockerenv.py ${NAME}"
                    echo "Failed to start container!"
                }
            }
        }
        stage("UDP connection Test") {
            steps {
                catchError(buildResult: "SUCCESS", stageResult: "FAILURE") {
                    dir("${INTTESTDIR}/connection") {
                        sh "python3 test_connection.py"
                    }
                }
            }
            post {
                always {
                    junit "reports/*.xml"
                }
            }
        }
        stage("DNS Query Test") {
            steps {
                catchError(buildResult: "SUCCESS", stageResult: "FAILURE") {
                    dir("${INTTESTDIR}/dnsquery") {
                        sh "python3 test_dnsQuery.py ${IPADDR}"
                    }
                }
            }
            post {
                always {
                    junit "reports/*.xml"
                }
            }
        }
    }
    post {
        always {
            sh "python3 /root/tools/deletedockerenv.py ${NAME}"
        }
    }
}
